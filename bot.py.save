# bot.py
import os

from discord.ext import commands
import discord
from dotenv import load_dotenv
from time import sleep
import time

from Scraper import Connection

global loop
loop = True

from black_friday_scraper import scrape_bf

load_dotenv()
TOKEN = os.getenv('DISCORD_TOKEN')

# Sets prefix for the usable commands
client = commands.Bot(command_prefix='$', intents=discord.Intents.all())

@client.command()
async def start_black_friday(ctx):
    await ctx.send("Starting Black Friday Scraping")
    
    while loop:
        # Scrape data
        data = scrape_bf()

        # Obtain information from database
        conn = Connection()
                
        for item in data:
                    
            # Obtain specified row from database
            result = conn.get(table="black_friday", where=f"item-name = {item['item-name']}")

            if len(result) > 0:
                # Check if the price has changed
                if result['item-price'] != item['item-price']:

                    # Update item price if it changed
                    conn.update(table="black_friday", setter={"item-price": item['item-price']}, where={"item-name": item['item-name']})

                # Alert if item price has dropped
                if result['item-price'] < item['item-price']:
                            
                    # Alert code
                    await ctx.send(f"@{user}: The price of {item['item-name']} went down from {result['item-price']} to {item['item-price']}!")
            else:
                conn.create(table="black_friday", data={"item-name": item['
]})
        # Wait 5 minutes before scraping again
        # Bot cannot sleep for more than 30 seconds


@client.command()
async def stop_black_friday(ctx):
    loop = False
    await ctx.send("Stopped Black Friday scraping")
client.run(TOKEN)
